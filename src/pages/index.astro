---
import { getCollection } from "astro:content";
import { Mail, Search } from "lucide-react";
import { Input } from "@/components/ui/input";
import YearFilterWithErrorBoundary from "../components/YearFilterWithErrorBoundary";
import Layout from "../layouts/Layout.astro";

const questions = await getCollection("questions");
questions.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const questionsWithExcerpts = questions.map((q) => ({
   ...q,
   excerpt: q.body
      .replace(/[#*[\]()]/g, "")
      .replace(/`/g, "")
      .slice(0, 150),
}));

const years = [
   ...new Set(questions.map((q) => q.data.date.getFullYear())),
].sort((a, b) => b - a);
---

<Layout title="Cassidoo's Interview Questions Archive">
   <div class="mb-8 space-y-4">
      <!-- Search and Year Filter -->
      <div class="flex gap-2 mx-auto max-w-4xl sm:flex-row">
         <div class="relative flex-1">
            <Search
               className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"
            />
            <Input
               type="text"
               id="search-input"
               placeholder="Search questions..."
               className="h-10 px-4 pl-10 rounded-lg border-slate-200 focus-visible:border-indigo-500 focus-visible:ring-indigo-200"
            />
         </div>

         <div id="year-filter-wrapper">
            <YearFilterWithErrorBoundary
               client:only="react"
               years={years}
               className="h-10! px-4 py-4 rounded-lg border-slate-200 focus-visible:border-indigo-500 focus-visible:ring-indigo-200"
            />
         </div>
         <select id="year-filter" class="hidden">
            <option value="">All Years</option>
            {years.map((year) => <option value={year}>{year}</option>)}
         </select>
      </div>

      <!-- Pagination Controls -->
      <div
         class="flex gap-3 p-4 mx-auto max-w-4xl bg-white rounded-lg border shadow-sm flex- col border-slate-100"
      >
         <div class="flex gap-4 justify-between items-center">
            <div class="flex gap-2 items-center">
               <label
                  for="page-size"
                  class="hidden text-sm text-slate-600 sm:inline">Show:</label
               >
               <select
                  id="page-size"
                  class="h-9 px-3 py-1 text-sm bg-transparent rounded-md border border-slate-200 shadow-xs transition-[color,box-shadow] outline-none focus-visible:border-indigo-500 focus-visible:ring-indigo-200 focus-visible:ring-[3px]"
               >
                  <option value="10" selected>10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
               </select>
               <span class="hidden text-sm text-slate-600 sm:inline"
                  >per page</span
               >
            </div>

            <div class="flex gap-2 items-center">
               <button
                  id="prev-page"
                  class="px-3 py-2 text-sm rounded-lg border transition-all sm:px-4 border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
               >
                  <span class="hidden sm:inline">←</span>
                  <span class="sm:hidden">‹</span>
               </button>
               <div class="flex gap-1.5 items-center">
                  <input
                     id="page-jump"
                     type="number"
                     min="1"
                     value="1"
                     class="h-9 w-12 sm:w-16 px-1.5 sm:px-2 py-1 text-sm text-center bg-transparent rounded-md border border-slate-200 shadow-xs transition-[color,box-shadow] outline-none focus-visible:border-indigo-500 focus-visible:ring-indigo-200 focus-visible:ring-[3px]"
                  />
                  <span class="text-sm text-slate-600">/</span>
                  <span class="text-sm text-slate-600" id="total-pages">1</span>
               </div>
               <button
                  id="next-page"
                  class="px-3 py-2 text-sm rounded-lg border transition-all sm:px-4 border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
               >
                  <span class="hidden sm:inline">→</span>
                  <span class="sm:hidden">›</span>
               </button>
            </div>

            <div class="hidden text-sm text-slate-600 sm:block">
               <span id="showing-range">1-10</span> of <span
                  id="total-questions">0</span
               >
            </div>
         </div>

         <!-- Mobile-only total count -->
         <div class="text-xs text-center text-slate-500 sm:hidden">
            <span id="showing-range-mobile">1-10</span> of <span
               id="total-questions-mobile">0</span
            > questions
         </div>
      </div>
   </div>

   <div id="questions-list" class="space-y-4">
      {
         questionsWithExcerpts.map((question) => (
            <a
               href={`/questions/${question.slug}`}
               class="block p-6 bg-white rounded-lg border shadow-sm transition-all question-item border-slate-100 hover:border-indigo-300 hover:shadow-md group"
               data-date={question.data.date.toISOString().split("T")[0]}
               data-number={question.data.number}
               data-year={question.data.date.getFullYear()}
            >
               <div class="flex justify-between items-start mb-2">
                  <span class="px-2 py-0.5 text-sm font-semibold text-indigo-600 bg-indigo-50 rounded-full transition-colors group-hover:bg-indigo-100">
                     #{question.data.number}
                  </span>
                  <time class="text-sm text-slate-400">
                     {question.data.date.toISOString().split("T")[0]}
                  </time>
               </div>
               <div class="question-excerpt text-slate-700 line-clamp-2 group-hover:text-slate-900">
                  {question.excerpt}...
               </div>
            </a>
         ))
      }
   </div>

   <div id="no-results" class="hidden py-12 text-center text-slate-500">
      No questions found matching your search.
   </div>
</Layout>

<script>
   let searchIndex: any[] = [];
   let currentPage = 1;
   let pageSize = 10;
   let filteredItems: HTMLElement[] = [];

   (async function () {
      try {
         const res = await fetch("/search.json");
         searchIndex = await res.json();
      } catch (err) {
         console.error("Failed to load search index", err);
      }
   })();

   const searchInput = document.getElementById("search-input");
   const yearFilter = document.getElementById("year-filter");
   const pageSizeSelect = document.getElementById("page-size");
   const pageJumpInput = document.getElementById("page-jump");
   const prevBtn = document.getElementById("prev-page");
   const nextBtn = document.getElementById("next-page");
   const totalPagesSpan = document.getElementById("total-pages");
   const totalQuestionsSpan = document.getElementById("total-questions");
   const totalQuestionsMobileSpan = document.getElementById(
      "total-questions-mobile"
   );
   const showingRangeSpan = document.getElementById("showing-range");
   const showingRangeMobileSpan = document.getElementById(
      "showing-range-mobile"
   );
   const list = document.getElementById("questions-list");
   const noResults = document.getElementById("no-results");

   function filterAndPaginate() {
      const searchTerm =
         (searchInput as HTMLInputElement)?.value.toLowerCase() || "";
      const selectedYear = (yearFilter as HTMLSelectElement)?.value || "";
      const items = Array.from(document.querySelectorAll(".question-item"));

      // Build matching slugs from search index
      const matchingSlugs = new Set<string>();
      if (searchTerm.length > 0 && searchIndex.length > 0) {
         for (const item of searchIndex) {
            if (
               item.excerpt.toLowerCase().includes(searchTerm) ||
               item.date.includes(searchTerm) ||
               String(item.number).includes(searchTerm) ||
               item.slug.includes(searchTerm)
            ) {
               matchingSlugs.add(item.slug);
            }
         }
      }

      // Filter items
      filteredItems = items.filter((item) => {
         if (!(item instanceof HTMLElement)) return false;

         const date = item.dataset.date || "";
         const number = item.dataset.number || "";
         const year = item.dataset.year || "";
         const href = item.getAttribute("href") || "";
         const slug = href.split("/").pop() || "";

         // Check year filter
         if (selectedYear && year !== selectedYear) {
            return false;
         }

         // Check search term
         let matchesTerm = false;
         if (searchTerm === "") {
            matchesTerm = true;
         } else if (searchIndex.length > 0) {
            matchesTerm = matchingSlugs.has(slug);
         } else {
            matchesTerm =
               date.includes(searchTerm) ||
               number.includes(searchTerm) ||
               (item.textContent || "").toLowerCase().includes(searchTerm);
         }

         return matchesTerm;
      }) as HTMLElement[];

      // Calculate pagination
      const totalItems = filteredItems.length;
      const totalPages = Math.ceil(totalItems / pageSize);

      // Ensure current page is valid
      if (currentPage > totalPages && totalPages > 0) {
         currentPage = totalPages;
      }
      if (currentPage < 1) {
         currentPage = 1;
      }

      // Update UI
      if (totalQuestionsSpan)
         totalQuestionsSpan.textContent = String(totalItems);
      if (totalQuestionsMobileSpan)
         totalQuestionsMobileSpan.textContent = String(totalItems);
      if (totalPagesSpan)
         totalPagesSpan.textContent = String(Math.max(totalPages, 1));
      if (pageJumpInput)
         (pageJumpInput as HTMLInputElement).value = String(currentPage);

      // Calculate range
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, totalItems);

      const rangeText = totalItems === 0 ? "0-0" : `${startIdx + 1}-${endIdx}`;
      if (showingRangeSpan) {
         showingRangeSpan.textContent = rangeText;
      }
      if (showingRangeMobileSpan) {
         showingRangeMobileSpan.textContent = rangeText;
      }

      // Show/hide items
      items.forEach((item) => {
         if (item instanceof HTMLElement) {
            item.style.display = "none";
         }
      });

      for (let i = startIdx; i < endIdx; i++) {
         filteredItems[i].style.display = "block";
      }

      // Update buttons
      if (prevBtn) {
         (prevBtn as HTMLButtonElement).disabled = currentPage === 1;
      }
      if (nextBtn) {
         (nextBtn as HTMLButtonElement).disabled =
            currentPage === totalPages || totalPages === 0;
      }

      // Show/hide no results
      if (noResults && list) {
         if (totalItems === 0) {
            noResults.classList.remove("hidden");
         } else {
            noResults.classList.add("hidden");
         }
      }
   }

   // Event listeners
   if (searchInput) {
      searchInput.addEventListener("input", () => {
         currentPage = 1;
         filterAndPaginate();
      });
   }

   if (yearFilter) {
      yearFilter.addEventListener("change", () => {
         currentPage = 1;
         filterAndPaginate();
      });
   }

   if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", (e) => {
         const select = e.target as HTMLSelectElement;
         pageSize = parseInt(select.value, 10);
         currentPage = 1;
         filterAndPaginate();
      });
   }

   if (prevBtn) {
      prevBtn.addEventListener("click", () => {
         if (currentPage > 1) {
            currentPage--;
            filterAndPaginate();
            window.scrollTo({ top: 0, behavior: "smooth" });
         }
      });
   }

   if (nextBtn) {
      nextBtn.addEventListener("click", () => {
         const totalPages = Math.ceil(filteredItems.length / pageSize);
         if (currentPage < totalPages) {
            currentPage++;
            filterAndPaginate();
            window.scrollTo({ top: 0, behavior: "smooth" });
         }
      });
   }

   if (pageJumpInput) {
      pageJumpInput.addEventListener("change", (e) => {
         const input = e.target as HTMLInputElement;
         const page = parseInt(input.value, 10);
         const totalPages = Math.ceil(filteredItems.length / pageSize);

         if (page >= 1 && page <= totalPages) {
            currentPage = page;
            filterAndPaginate();
            window.scrollTo({ top: 0, behavior: "smooth" });
         } else {
            input.value = String(currentPage);
         }
      });
   }

   // Initial load
   filterAndPaginate();
</script>
