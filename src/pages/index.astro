---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";

const questions = await getCollection("questions");
questions.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const questionsWithExcerpts = questions.map((q) => ({
	...q,
	excerpt: q.body
		.replace(/[#*[\]()]/g, "")
		.replace(/`/g, "")
		.slice(0, 150),
}));
---

<Layout title="Cassidoo's Interview Questions Archive">
   <div class="mb-8">
      <div class="relative max-w-lg mx-auto">
         <input
            type="text"
            id="search-input"
            placeholder="Search questions..."
            class="w-full px-4 py-3 pl-12 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all shadow-sm"
         />
         <svg
            class="absolute left-4 top-3.5 h-5 w-5 text-slate-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
         >
            <path
               stroke-linecap="round"
               stroke-linejoin="round"
               stroke-width="2"
               d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
         </svg>
      </div>
   </div>

   <div id="questions-list" class="space-y-4">
      {
         questionsWithExcerpts.map((question) => (
            <a
               href={`/questions/${question.slug}`}
               class="question-item block bg-white p-6 rounded-lg shadow-sm border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all group"
               data-date={question.data.date.toISOString().split("T")[0]}
               data-number={question.data.number}
            >
               <div class="flex justify-between items-start mb-2">
                  <span class="text-sm font-semibold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full group-hover:bg-indigo-100 transition-colors">
                     #{question.data.number}
                  </span>
                  <time class="text-sm text-slate-400">
                     {question.data.date.toISOString().split("T")[0]}
                  </time>
               </div>
               <div class="question-excerpt text-slate-700 line-clamp-2 group-hover:text-slate-900">
                  {question.excerpt}...
               </div>
            </a>
         ))
      }
   </div>

   <div id="no-results" class="hidden text-center py-12 text-slate-500">
      No questions found matching your search.
   </div>
</Layout>

<script>
   let searchIndex: any[] = [];

   (async function () {
      try {
         const res = await fetch("/search.json");
         searchIndex = await res.json();
      } catch (err) {
         console.error("Failed to load search index", err);
      }
   })();

   const searchInput = document.getElementById("search-input");
   const list = document.getElementById("questions-list");
   const noResults = document.getElementById("no-results");

   if (searchInput && list && noResults) {
      searchInput.addEventListener("input", (e) => {
         const input = e.target;
         if (!(input instanceof HTMLInputElement)) return;

         const term = input.value.toLowerCase();
         const items = document.querySelectorAll(".question-item");
         let hasVisible = false;

         const matchingSlugs = new Set<string>();
         if (term.length > 0 && searchIndex.length > 0) {
            for (const item of searchIndex) {
               if (
                  item.excerpt.toLowerCase().includes(term) ||
                  item.date.includes(term) ||
                  String(item.number).includes(term) ||
                  item.slug.includes(term)
               ) {
                  matchingSlugs.add(item.slug);
               }
            }
         }

         for (const item of items) {
            if (!(item instanceof HTMLElement)) continue;

            const date = item.dataset.date || "";
            const number = item.dataset.number || "";
            const href = item.getAttribute("href") || "";
            const slug = href.split("/").pop() || "";

            let matchesTerm = false;
            if (term === "") {
               matchesTerm = true;
            } else if (searchIndex.length > 0) {
               matchesTerm = matchingSlugs.has(slug);
            } else {
               matchesTerm =
                  date.includes(term) ||
                  number.includes(term) ||
                  (item.textContent || "").toLowerCase().includes(term);
            }

            if (matchesTerm) {
               item.style.display = "block";
               hasVisible = true;
            } else {
               item.style.display = "none";
            }
         }

         if (hasVisible) {
            noResults.classList.add("hidden");
         } else {
            noResults.classList.remove("hidden");
         }
      });
   }
</script>
