---
interface Question {
  slug: string;
  number: number;
  date: string;
  excerpt: string;
  year: number;
}

interface Props {
  questions: Question[];
  years: number[];
}

const { questions, years } = Astro.props;

// Initial state for server rendering (optional, but good for SEO/Flash of content)
// We'll render the first page server-side.
const initialPageSize = 10;
const initialQuestions = questions.slice(0, initialPageSize);
const totalItems = questions.length;
const showingRange = `0-${Math.min(initialPageSize, totalItems)}`;
---

<div id="questions-app" class="mb-4 space-y-4">
  <!-- Search and Year Filter -->
  <div class="flex gap-2 mx-auto max-w-4xl sm:flex-row">
    <div class="relative flex-1">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.3-4.3"></path>
      </svg>
      <input
        type="text"
        id="search-input"
        placeholder="Search questions..."
        class="file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-10 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive pl-10 bg-background"
      />
    </div>

    <div class="relative w-[180px]">
      <select
        id="year-select"
        class="flex h-10 w-full items-center justify-between gap-2 whitespace-nowrap rounded-md border border-input bg-background px-3 py-2 text-sm shadow-xs ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 appearance-none"
      >
        <option value="">All Years</option>
        {years.map((year) => <option value={year}>{year}</option>)}
      </select>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-chevron-down h-4 w-4 opacity-50 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"
      >
        <path d="m6 9 6 6 6-6"></path>
      </svg>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div
    class="flex gap-3 p-4 mx-auto max-w-4xl bg-white rounded-lg border shadow-sm flex-col border-slate-100"
  >
    <div class="flex gap-4 justify-between items-center">
      <div class="flex gap-2 items-center">
        <label for="page-size-select" class="hidden text-sm text-slate-600 sm:inline">
          Show:
        </label>
        <div class="relative">
            <select
            id="page-size-select"
            class="flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-xs ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 appearance-none pr-8"
            >
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            </select>
             <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-chevron-down h-4 w-4 opacity-50 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"
            >
                <path d="m6 9 6 6 6-6"></path>
            </svg>
        </div>
        <span class="hidden text-sm text-slate-600 sm:inline"> per page </span>
      </div>

      <div class="flex gap-2 items-center">
        <button
          id="prev-page-btn"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-8 rounded-md px-3 has-[>svg]:px-2.5"
          disabled
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="size-4"
          >
            <path d="m15 18-6-6 6-6"></path>
          </svg>
        </button>
        <div class="flex gap-1.5 items-center">
          <input
            type="number"
            id="page-input"
            min="1"
            value="1"
            class="file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input min-w-0 rounded-md border bg-transparent shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive text-sm h-9 w-10 sm:w-10 px-1.5 sm:px-2 text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
          />
          <span class="text-sm text-slate-600">/</span>
          <span id="total-pages-display" class="text-sm text-slate-600">
            {Math.ceil(totalItems / initialPageSize)}
          </span>
        </div>
        <button
          id="next-page-btn"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-8 rounded-md px-3 has-[>svg]:px-2.5"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="size-4"
          >
            <path d="m9 18 6-6-6-6"></path>
          </svg>
        </button>
      </div>

      <div id="showing-range" class="hidden text-sm text-slate-600 sm:block">
        {showingRange} of {totalItems}
      </div>
    </div>

    <!-- Mobile-only total count -->
    <div id="showing-range-mobile" class="text-xs text-center text-slate-500 sm:hidden">
      {showingRange} of {totalItems} questions
    </div>
  </div>

  <!-- Questions List -->
  <div id="questions-list" class="flex flex-col gap-2">
    {
      initialQuestions.map((question) => (
        <a href={`/questions/${question.slug}`}>
          <div class="rounded-xl border bg-card text-card-foreground shadow transition-all hover:border-indigo-300 hover:shadow-md group cursor-pointer">
            <div class="p-6">
              <div class="flex justify-between items-start mb-2">
                <div class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-indigo-50 text-indigo-600 hover:bg-indigo-100">
                  #{question.number}
                </div>
                <time class="text-sm text-slate-400">{question.date}</time>
              </div>
              <div class="text-slate-700 line-clamp-2 group-hover:text-slate-900">
                {question.excerpt}...
              </div>
            </div>
          </div>
        </a>
      ))
    }
  </div>
    <div id="no-results" class="hidden py-12 text-center text-slate-500">
        No questions found matching your search.
    </div>
</div>

<script define:vars={{ questions, initialPageSize }}>
  let allQuestions = questions;
  let filteredQuestions = [...allQuestions];
  let currentPage = 1;
  let pageSize = initialPageSize;
  let searchTerm = "";
  let selectedYear = "";
  let searchIndex = [];

  // DOM Elements
  const searchInput = document.getElementById("search-input");
  const yearSelect = document.getElementById("year-select");
  const pageSizeSelect = document.getElementById("page-size-select");
  const prevPageBtn = document.getElementById("prev-page-btn");
  const nextPageBtn = document.getElementById("next-page-btn");
  const pageInput = document.getElementById("page-input");
  const totalPagesDisplay = document.getElementById("total-pages-display");
  const showingRangeEl = document.getElementById("showing-range");
  const showingRangeMobileEl = document.getElementById("showing-range-mobile");
  const questionsListEl = document.getElementById("questions-list");
  const noResultsEl = document.getElementById("no-results");

  // Load search index
  fetch("/search.json")
    .then((res) => res.json())
    .then((data) => {
      searchIndex = data;
    })
    .catch((err) => console.error("Failed to load search index", err));

  function renderQuestions() {
    const totalPages = Math.ceil(filteredQuestions.length / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = Math.min(startIdx + pageSize, filteredQuestions.length);
    const paginatedQuestions = filteredQuestions.slice(startIdx, endIdx);

    // Update Pagination UI
    pageInput.value = currentPage;
    pageInput.max = totalPages;
    totalPagesDisplay.textContent = Math.max(totalPages, 1);
    
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

    const rangeText = filteredQuestions.length === 0 ? "0-0" : `${startIdx + 1}-${endIdx}`;
    showingRangeEl.textContent = `${rangeText} of ${filteredQuestions.length}`;
    showingRangeMobileEl.textContent = `${rangeText} of ${filteredQuestions.length} questions`;

    // Render Questions
    if (paginatedQuestions.length > 0) {
      questionsListEl.innerHTML = paginatedQuestions
        .map(
          (q) => `
        <a href="/questions/${q.slug}">
            <div class="rounded-xl border bg-card text-card-foreground shadow transition-all hover:border-indigo-300 hover:shadow-md group cursor-pointer">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <div class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-indigo-50 text-indigo-600 hover:bg-indigo-100">
                            #${q.number}
                        </div>
                        <time class="text-sm text-slate-400">${q.date}</time>
                    </div>
                    <div class="text-slate-700 line-clamp-2 group-hover:text-slate-900">
                        ${q.excerpt}...
                    </div>
                </div>
            </div>
        </a>
      `
        )
        .join("");
      questionsListEl.classList.remove("hidden");
      noResultsEl.classList.add("hidden");
    } else {
      questionsListEl.innerHTML = "";
      questionsListEl.classList.add("hidden");
      noResultsEl.classList.remove("hidden");
    }
  }

  function filterQuestions() {
    filteredQuestions = allQuestions;

    // Filter by year
    if (selectedYear) {
      filteredQuestions = filteredQuestions.filter(
        (q) => q.year === parseInt(selectedYear, 10)
      );
    }

    // Filter by search term
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      if (searchIndex.length > 0) {
          const matchingSlugs = new Set();
          searchIndex.forEach((item) => {
              if (
                  item.excerpt.toLowerCase().includes(term) ||
                  item.date.includes(term) ||
                  String(item.number).includes(term) ||
                  item.slug.includes(term)
              ) {
                  matchingSlugs.add(item.slug);
              }
          });
          filteredQuestions = filteredQuestions.filter((q) => matchingSlugs.has(q.slug));
      } else {
          // Fallback if search index not loaded yet
           filteredQuestions = filteredQuestions.filter(
            (q) =>
                q.date.includes(term) ||
                String(q.number).includes(term) ||
                q.excerpt.toLowerCase().includes(term)
          );
      }
    }

    // Reset to page 1 if pages reduced
    const totalPages = Math.ceil(filteredQuestions.length / pageSize);
    if (currentPage > totalPages) {
        currentPage = 1;
    } else if (currentPage === 0 && totalPages > 0) {
        currentPage = 1;
    }
    
    // Always reset to page 1 on filter change? React app did:
    // setCurrentPage(1); when filters change.
    // But we need to be careful not to reset if we just loaded (but here filter is called on input)
    // Let's track if filters changed vs page change.
    // For now, simplistic approach: if filtering triggered this, reset page to 1.
    // I'll separate the reset logic into event handlers.
    
    renderQuestions();
  }

  // Event Listeners
  searchInput.addEventListener("input", (e) => {
    searchTerm = e.target.value;
    currentPage = 1;
    filterQuestions();
  });

  yearSelect.addEventListener("change", (e) => {
    selectedYear = e.target.value;
    currentPage = 1;
    filterQuestions();
  });

  pageSizeSelect.addEventListener("change", (e) => {
    pageSize = parseInt(e.target.value, 10);
    currentPage = 1;
    renderQuestions();
  });

  prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      window.scrollTo({ top: 0, behavior: "smooth" });
      renderQuestions();
    }
  });

  nextPageBtn.addEventListener("click", () => {
    const totalPages = Math.ceil(filteredQuestions.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      window.scrollTo({ top: 0, behavior: "smooth" });
      renderQuestions();
    }
  });

  pageInput.addEventListener("change", (e) => {
    let val = parseInt(e.target.value, 10);
    const totalPages = Math.ceil(filteredQuestions.length / pageSize);
    if (val >= 1 && val <= totalPages) {
        currentPage = val;
        renderQuestions();
    } else {
        e.target.value = currentPage;
    }
  });
  
  pageInput.addEventListener("keydown", (e) => {
      if(e.key === 'Enter') {
         pageInput.blur();
      }
  })
</script>
